<%-include ("../partials/header")  -%>

<!-- maxbox setting -->
<script src='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v0.10.1/mapbox-gl-language.js'></script>
<%-include ("../partials/messages")  -%>
<div class="row">
    <div class="col-md-3 fix">

        <a href="javascript:history.back()" class="btn btn-outline-primary mt-4" style="width: 100%;"><i class="fas fa-angle-double-left"></i> &nbsp 返回上一頁</a>

        <div id="map" style="margin-top:40px; height:400px; border-radius:10px">
        </div>

        <p class="mt-2">地址：
            <a href="https://www.google.com.tw/maps/place/<%= store.address %>">
                <%= store.address %>
            </a>
        </p>


    </div>
    <div class="col-md-9 h-scroll scrollbar-light-blue">
        <div class="thumbnail">
            <div class="caption-full">

                <a class="btn btn-orange badge-pill my-2" href="/stores?search=<%= store.city  %>"><%= store.city %></span></a>
                <!-- 追蹤/取消追蹤 -->
                <% if (currentUser){  %>
                <% if(store.followers.includes(currentUser._id)){ %>
                <a class="btn btn-secondary my-2" href="/stores/<%= store._id %>/unfollow">取消追蹤</span></a>
                <% }else{ %>
                <a class="btn btn-primary my-2" href="/stores/<%= store._id %>/follow">追蹤</span></a>
                <% } %>
                <% } %>

                <!-- Admin編輯刪除 -->
                <div class="btn-group float-right my-2">
                    <% if ((currentUser && currentUser.userRole) && (currentUser.userRole === 1 || (currentUser.userRole === 2 && currentUser.hasStore.includes(store._id)))){ %>
                    <button type="button" class="btn btn-light my-2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
                    </button>
                    <div class="dropdown-menu my-2">

                        <a class="dropdown-item" href="/stores/<%=store._id  %>/edit ">編輯店家</a>

                        <button id="delete-btn" type="button" class="dropdown-item" data-toggle="modal" data-target="#deleteStoreModal">
                            刪除
                        </button>
                    </div>
                    <%}%>
                </div>





                <!-- 店家標題開始 -->
                <h2><%=store.name %></h2>

                <div class="my-2">
                    <a href="/stores/<%= store._id %>/reviews">
                        <span><strong><%= store.rating.toFixed(1) %></strong></span>
                        <%-include ("../partials/showrating",{rating: store.rating})  -%>
                        <em>(<%= store.reviews.length %>)</em>
                    </a>
                </div>
                <!-- 店家標題結束 -->


                <!-- 標籤按鈕開始 -->
                <nav class="my-4">
                    <div class="nav nav-tabs nav-justified" id="nav-tab" role="tablist">
                        <a class="nav-item nav-link active" id="nav-intro-tab" data-toggle="tab" href="#nav-intro" role="tab" aria-controls="nav-intro" aria-selected="true">簡介
                        </a>
                        <a class="nav-item nav-link" id="nav-review-tab" data-toggle="tab" href="#nav-review" role="tab" aria-controls="nav-review" aria-selected="false">
                            評論/食記 ( <span><%= store.reviews.length %> </span> )
                        </a>

                    </div>
                </nav>
                <!-- 標籤按鈕結束 -->
                <div class="tab-content" id="nav-tabContent">
                    <div class="tab-pane fade show active" id="nav-intro" role="tabpanel" aria-labelledby="nav-intro-tab">
                        <!-- 店家照片開始 -->
                        <div id="carouselControls" class="carousel slide" data-ride="carousel">
                            <div class="carousel-inner">
                                <div class="carousel-item active">
                                    <img class="d-block w-100" src="<%= store.imageLarge[0] %>" alt="First slide" width="600" height="500">
                                </div>
                                <% store.imageSmall.forEach((image)=>{ %>

                                <div class="carousel-item">
                                    <img class="d-block w-100" src="<%= image %>" width="600" height="500">
                                </div>

                                <%})  %>
                                <% store.imageLarge.forEach((image)=>{ %>

                                <div class="carousel-item">
                                    <img class="d-block w-100" src="<%= image %>" width="600" height="500">
                                </div>

                                <%})  %>
                            </div>
                            <a class="carousel-control-prev" href="#carouselControls" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="carousel-control-next" href="#carouselControls" role="button" data-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                            </a>
                        </div>
                        <!-- 店家照片結束 -->


                        <div class="row">

                            <div class="col-sm-11">
                                <strong>
                                    <h3 class="mt-4">介紹</h3>
                                </strong>
                            </div>
                        </div>

                        <hr>
                        <% if(!store.descriptionHTML){ %>
                        <p><%- store.descriptionText -%> </p>
                        <% }else{  %>
                        <p><%- store.descriptionHTML -%> </p>
                        <% } %>

                        <p> <em>於 <%= moment(store.updatedAt).fromNow() %> 更新</em> </p>


                        <!-- comment section -->
                        <div class="well">
                            <%  if (currentUser){%>
                            <div class="text-left">
                                <a class="btn btn-success" role="button" data-toggle="collapse" href="#collapseComment" aria-expanded="false" aria-controls="collapseComment">
                                    <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
                                    留言
                                </a>
                            </div>

                            <hr>

                            <!--Comment section title-->
                            <h4><strong>留言 <span class="glyphicon glyphicon glyphicon-comment" aria-hidden="true"></span></strong></h4>
                            <!--Collapse Add a comment form START-->
                            <div class="collapse" id="collapseComment">
                                <div class="well">
                                    <!-- Commetn Form -->
                                    <form id="add-comment-form" action="/stores/<%= store._id %>/comments" method="POST">
                                        <div class="form-group">
                                            <input class="form-control" type="text" disabled value="<%= currentUser.fbName %>">
                                        </div>
                                        <div class="form-group">
                                            <textarea class="form-control" name="comment[text]" placeholder="Write your comment..." form="add-comment-form" rows="5" cols="70"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <button class="btn btn-success btn-sm">Comment <span class="glyphicon glyphicon-comment" aria-hidden="true"></span></button>
                                        </div>
                                    </form>

                                </div>
                            </div>
                            <!--Collapse Add a comment form END-->
                            <% } %>
                            <hr>

                            <!--Check if there are comments, if there are none say no comments.-->
                            <% if (store.comments.length === 0) { %>
                            <em style="color: grey;">尚無留言</em>
                            <% } %>


                            <div id="comment">
                                <%-include ("../partials/showcomment")  -%>
                            </div>


                        </div>



                    </div>
                    <!--評論區 -->
                    <div class="tab-pane fade" id="nav-review" role="tabpanel" aria-labelledby="nav-review-tab">

                        <div id="review">
                            <%-include ("../partials/showreview")  -%>
                        </div>
                    </div>

                </div>
            </div>
        </div>



    </div>
</div>

<!-- 刪除店家modal -->
<div class="modal fade" id="deleteStoreModal" tabindex="-1" role="dialog" aria-labelledby="deleteStoreModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="border: 10px solid red;">
            <div class="modal-header">
                <h4 class="modal-title" id="deleteStoreModalTitle">刪除店家 </h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h5>即將刪除：</h5>
                <p style="text-align: justify; word-wrap: break-word;">
                    <%=store.name %>
                </p>
                <h5>為了防止誤刪，請在下方輸入完整店名:</h5>
                <input class="form-control" id="deleteformInput" required>
            </div>
            <div class=" modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <form class="delete-review-form" action="/stores/<%=store._id  %>?_method=DELETE" method="POST">
                    <button id="deleteStoreBtn" class="btn btn-danger" disabled="disabled">確定刪除店家</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- mapbox setting -->
<script type="text/javascript">
    /* beautify preserve:start */
    mapboxgl.accessToken = '<%= mapboxAccessToken %>';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v10',
        zoom: 15,
        //longitude 經度, latitude緯度 
        center: [ <%= store.location.coordinates[0] %> , <%= store.location.coordinates[1] %> ]

    });
    mapboxgl.setRTLTextPlugin('https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.1.0/mapbox-gl-rtl-text.js');

    map.addControl(new MapboxLanguage({
                defaultLanguage: 'zh'
            }));
    var marker = new mapboxgl.Marker()
        .setLngLat([<%= store.location.coordinates[0] %> , <%= store.location.coordinates[1] %>])
        .addTo(map);
    /* beautify preserve:end */
</script>
<script type="text/javascript">
    /* beautify preserve:start */
    let deleteStoreBtn = document.getElementById('deleteStoreBtn');
    let deleteformInput = document.getElementById('deleteformInput');
    window.addEventListener('keyup', function() {
        console.log(deleteformInput.value)
        if (deleteformInput.value === '<%= store.name %>' ) {
            deleteStoreBtn.removeAttribute('disabled')
        } else {
            deleteStoreBtn.setAttribute('disabled', 'disabled')
        }
    })
    /* beautify preserve:end */
</script>


<%-include ("../partials/footer") -%>
