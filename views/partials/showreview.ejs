<link rel="stylesheet" href="/stylesheets/review-grid.css">

<% if(store.reviews.length <1){ %>
<p>尚無評論/食記，快來上傳第一篇吧！</p>
<% } %>
<% store.reviews.slice(0, 5).forEach(function(review){ %>
<div class="row">

    <!-- 作者 -->
    <div class="grid-container">
        <div class="avatar">
            <img class="img-responsive" src="<%= review.author.avatar %> " alt="" style="border-radius: 50%;">
        </div>
        <div class="userName">
            <h5><strong><%= review.author.username %></strong></h5>
        </div>
        <div class="userRating">
            <%-include ("./showrating",{rating:review.rating})  -%>
            <span><%= moment(review.updatedAt).fromNow() %></span>
        </div>

        <div class="functionBtn">

            <div class="btn-group dropleft">
                <% if(currentUser && review.author.id.equals(currentUser._id)){ %>
                <button type="button" class="btn btn-light " data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
                </button>
                <div class="dropdown-menu">

                    <a class="dropdown-item" href="/stores/<%=store._id %>/reviews/<%=review._id %>/edit">編輯</a>

                    <button id="delete-btn" type="button" class="dropdown-item" data-toggle="modal" data-target="#deleteReviewModal">
                        刪除
                    </button>

                </div>
                <% } %>
            </div>
        </div>
    </div>


</div>

<p class="mt-4" style="text-align: justify; word-wrap: break-word;">
    <%= review.text %>
</p>

<!-- 確認刪除modal -->
<div class="modal fade" id="deleteReviewModal" tabindex="-1" role="dialog" aria-labelledby="deleteReviewModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="deleteReviewModalTitle">刪除評論/食記 </h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h5>即將刪除：</h5>

                <p style="text-align: justify; word-wrap: break-word;">
                    <% if(review.text.length > 100){  %>
                    <%= review.text.substring(0, 100) %>
                    <%}else{  %>
                    <%= review.text %>
                    <% }  %>
                </p>
            </div>
            <div class=" modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <form id="delete-form" action="/stores/<%=store._id %>/reviews/<%=review._id %>?_method=DELETE" method="POST">
                    <input type="submit" value="刪除" class="btn btn-danger" id="delete-review-input">
                </form>
            </div>
        </div>
    </div>
</div>



<hr>
<% }); %>
<% if(store.reviews.length >5){ %>
<div style="margin-bottom: 10px;">
    <h4><a href="/stores/<%= store._id %>/reviews"><i class="fa fa-search" aria-hidden="true"></i> 查看全部評論</a></h4>
</div>
<% } %>

<div>
    <!-- 評論modalBtn -->
    <a href="#" id="modalBtn" class="btn btn-lg btn-primary <% if (currentUser && store.reviews.some(function (review) {return review.author.id.equals(currentUser._id)})) { %> disabled <% } %>" data-toggle="modal" data-target="#newReviewModal"> 評論或評分</a>
</div>



<!-- 評論modal -->
<div class="modal fade" id="newReviewModal" tabindex="-1" role="dialog" aria-labelledby="newReviewModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered  modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h3 class="modal-title w-100"><i class="fas fa-comment-alt-edit"></i> &nbsp 評分或評論：</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <p>店家：<%= store.name %></p>

                <%-include ("../partials/newreview") -%>

            </div>

        </div>
    </div>
</div>
<script>
    $(document).ready(function() {
        if ($('#modalBtn').hasClass('disabled')) {
            $('#modalBtn').text('您已經發表評論')
        }
    })
</script>